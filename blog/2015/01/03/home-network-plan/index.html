
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Home Network Plan - Toger Blog</title>
  <meta name="author" content="Jason Martin jhmartin@toger.us">

  
  <meta name="description" content="I have several daughters, the oldest of which is just becoming familiar with the Internet. Her grandparents also bought her a WiFi tablet for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="E6g-RygMY6w5OqT7qnwKg3eJJnGYWWhMysZEcgihuB8" />

  
  <link rel="canonical" href="http://www.toger.us/blog/2015/01/03/home-network-plan">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Toger Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-50432157-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Toger Blog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.toger.us" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/gpg-pgp-key">GPG/PGP Key</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Home Network Plan</h1>
    
    
      <p class="meta">
        








  



<time datetime="2015-01-03T20:17:22-08:00" pubdate data-updated="true">Jan 3<sup>rd</sup>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I have several daughters, the oldest of which is just becoming familiar with the Internet.  Her grandparents also bought her a WiFi tablet for Christmas.  I know that keeping an eye on her usage is the best approach, but I wanted technology to help backstop that.  And, because it is interesting to do, I want to way overbuild the environment Just Because.</p>

<p>The technologies:</p>

<ul>
<li>Squid</li>
<li>DansGuardian</li>
<li>ElasticSearch/LogStash/Kibana</li>
<li>Logstash-forwarder</li>
<li>Raspberry Pi</li>
<li>AWS</li>
</ul>


<p>She is not sophisticated enough to actively undo any of the protections I might put in (yet!!).  So for the mean time the config has to be just good enough rather then prevent a determined attacker.</p>

<p>What I have done is set up a Raspberry Pi on the network that runs Squid+DansGuardian, and configure her devices to utilize that for a web proxy.  Logstash-forwarder forwards the logs for Squid and DansGuardian to a EC2 t2.micro instance that parses/indexes them, and I&rsquo;ve set up reports that show me what domains she&rsquo;s connected to. Finally, I&rsquo;ve configured the RouterBOARD 750GL to utilize NetFlow logging to send NetFlow data to EC2 as well, so I can track what domains non-http/https traffic uses.</p>

<p>I am utilizing EC2 for log processing as my Pi just isn&rsquo;t big enough to run squid/dansguardian plus an ELK stack. I might migrate to a SaaS solution at some point.</p>

<p>I expect to utilize the ElasticSearch function to spool daily logs out to S3 and on to Glacier.  I don&rsquo;t have a specific reason to do this as the logs aren&rsquo;t really meaningful after a week or so, but it is just something to tool around with. The NetFlow logs could be useful at some point if there was a question about the accuracy of my ISP&rsquo;s metering though.</p>

<p>Future enhancements will be to put the wireless devices / her network jacks into their own VLAN and either transparently proxy them or disallow unproxied content.  Further would be to upgrade Squid to the version that can MitM SSL connections and add a trusted cert to her devices.</p>

<p>The layout so far:</p>

<!-- more -->


<p><img src="http://www.gliffy.com/go/publish/image/6859613/L.png"></p>

<p>I want to underscore all th is is &lsquo;Because I Can&rsquo; / it is an interesting challenge rather than because I strictly need this to provide all the protection from the darker places on the Internet.  We keep an eye on what she does and restrict her Internet access to use in &lsquo;public&rsquo; portions of the house &mdash; No private internet access.</p>

<p>NetFlow config on the 750GL:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ip traffic-flow
</span><span class='line'>set enabled=yes interfaces=&lt;pppoe/outgoing interface&gt;
</span><span class='line'>/ip traffic-flow target
</span><span class='line'>add address=&lt;logstashhostIP:port&gt; version=5</span></code></pre></td></tr></table></div></figure>


<p>Logstash configuration on the remote end:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>input {
</span><span class='line'>
</span><span class='line'>lumberjack {
</span><span class='line'>    port =&gt; 5043
</span><span class='line'>    type =&gt; "squid"
</span><span class='line'>    ssl_certificate =&gt; "/home/ec2-user/logstash-forwarder/logstash-forwarder.crt"
</span><span class='line'>    ssl_key =&gt; "/home/ec2-user/logstash-forwarder/logstash-forwarder.key"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>    udp {
</span><span class='line'>      port =&gt; 1234
</span><span class='line'>      codec =&gt; netflow {
</span><span class='line'>        definitions =&gt; "/home/ec2-user/logstash-1.4.2/lib/logstash/codecs/netflow/netflow.yaml"
</span><span class='line'>        versions =&gt; [5]
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>filter {
</span><span class='line'> # https://gist.github.com/sakalajuraj/6339942
</span><span class='line'> grok {
</span><span class='line'>  type =&gt; "squid"
</span><span class='line'>  pattern =&gt; "%{NUMBER:timestamp}\s+%{NUMBER:request_msec:float} %{IPORHOST:src_ip} %{WORD:cache_result}/%{NUMBER:response_status:int} %{NUMBER:response_size:int} %{WORD:http_method} (%{URIPROTO:http_proto}://)?%{IPORHOST:dst_host}(?::%{POSINT:port})?(?:%{URIPATHPARAM:uri_param})? %{USERNAME:cache_user} %{WORD:request_route}/(%{IPORHOST:forwarded_to}|-) %{GREEDYDATA:content_type}"
</span><span class='line'>  add_tag =&gt; "squid"
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'> geoip {
</span><span class='line'>  source =&gt; "dst_host"
</span><span class='line'>  type =&gt; "squid"
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'> date {
</span><span class='line'>  tags =&gt; "squid"
</span><span class='line'>  match =&gt; [ "timestamp", "UNIX" ]
</span><span class='line'> }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output {
</span><span class='line'>    elasticsearch_http {
</span><span class='line'>       index =&gt; "logstash_netflow5-%{+YYYY.MM.dd}"
</span><span class='line'>       host =&gt; "localhost"
</span><span class='line'>       port =&gt; 9200
</span><span class='line'>       type =&gt; "logs"
</span><span class='line'>     }
</span><span class='line'>
</span><span class='line'>    elasticsearch_http {
</span><span class='line'>       index =&gt; "logstash-%{+YYYY.MM.dd}"
</span><span class='line'>       host =&gt; "localhost"
</span><span class='line'>       port =&gt; 9200
</span><span class='line'>       type =&gt; "squid"
</span><span class='line'>     }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>I followed <a href="http://dave.cheney.net/2012/09/08/an-introduction-to-cross-compilation-with-go">http://dave.cheney.net/2012/09/08/an-introduction-to-cross-compilation-with-go</a> to cross-compile logstash-forwarder for ARM.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jason Martin jhmartin@toger.us</span></span>

      








  



<time datetime="2015-01-03T20:17:22-08:00" pubdate data-updated="true">Jan 3<sup>rd</sup>, 2015</time>
      


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2015/01/07/mesos/" title="Next Post: Mesos, Docker and Consul">Mesos, Docker and Consul &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/08/19/dns-as-a-load-balancer/">DNS as a Service Discovery Load Balancer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/24/home-automation-ideas/">Home Automation Ideas</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/17/jenkins-and-github-hooks/">Jenkinsfile and Github Hooks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/20/aws-route53-failover-and-alb/">AWS Route53 Failover and ALB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/08/cloud-init-with-centos7-and-chef/">Cloud-Init With CentOS7, Chef, and SELinux</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/jhmartin">@jhmartin</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jhmartin',
            count: 21,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/105964388252097959079?rel=author">
      <img src="//www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Jason Martin jhmartin@toger.us -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>







</body>
</html>
